<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Jersey+15&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <title>Recommender System Movie Search</title>
</head>
<body>
<input type="text" placeholder="Search movies" name="searchBar" id="searchBar">
<div id="search_btn" style="cursor: pointer">
    <p>Search</p>
</div>

<div id="results">

</div>

<div id="loadMore">
    <div id="loadMoreBtn" style="cursor: pointer">
        <p>Load More</p>
    </div>
</div>

<script>
    let currentDisplayedMovies = 0

    const search_btn = document.getElementById("search_btn")
    search_btn.onclick = async function() {
        showLoading()
        const searchValue = document.getElementById("searchBar").value
        const response = await fetch(`/search_db?query=${searchValue}&offset=0`)
        const data = await response.json()
        console.log(data.movies.length)
        displayMovies(data.movies, false)
    }

    const load_more_btn = document.getElementById("loadMoreBtn")
    load_more_btn.onclick = async function() {
        const searchValue = document.getElementById("searchBar").value
        const response = await fetch(`/search_db?query=${searchValue}&offset=${currentDisplayedMovies}`)
        const data = await response.json()
        console.log(data.movies.length)
        displayMovies(data.movies, true)
    }

    // Fetch all on load
    window.onload = async function() {
        showLoading()
        const response = await fetch(`/search_db?offset=0&query=`)
        const data = await response.json()
        console.log(data.movies.length)
        displayMovies(data.movies, false)
    }

    function showLoading() {
        const resultsDiv = document.getElementById("results")
        resultsDiv.innerHTML = ''

        const loading = document.createElement("p")
        loading.textContent = "Loading..."

        resultsDiv.appendChild(loading)
    }

    function displayMovies(movies, append) {
        const resultsDiv = document.getElementById("results")

        if (!append) {
            load_more_btn.style.display = "block"

            currentDisplayedMovies = movies.length
            resultsDiv.innerHTML = ''
        } else {
            currentDisplayedMovies += movies.length

            if (movies.length == 0) {
                load_more_btn.style.display = "none"
            }
        }


        // Adding search result movies
        movies.forEach(movie => {
            const movieNode = document.createElement("div")
            movieNode.style = "display: flex"

            const title = document.createElement("p")
            title.textContent = movie.title

            movieNode.appendChild(title)

            resultsDiv.appendChild(movieNode)
        })

    }

</script>
</body>
</html>